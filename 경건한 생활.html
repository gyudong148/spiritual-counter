<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ê±´í•œ ìƒí™œ ì¹´ìš´í„°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .current-month {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .add-item-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .add-item-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(132, 250, 176, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 154, 158, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .items-section {
            margin-bottom: 30px;
        }

        .items-section h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .item-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .item-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-name {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .item-count {
            font-size: 2em;
            font-weight: 700;
            color: #4facfe;
            margin: 0 20px;
        }

        .item-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .history-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .history-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .history-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item:nth-child(even) {
            background: #f8f9fa;
        }

        .monthly-archive {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .monthly-archive h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .archive-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #1976d2;
        }

        .month-controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .empty-message {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        @media (max-width: 600px) {
            .input-group {
                flex-direction: column;
            }
            
            .item-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .item-controls {
                justify-content: center;
            }
            
            .month-controls {
                text-align: center;
            }
            
            .month-controls button {
                margin: 5px;
                width: 100%;
                max-width: 250px;
            }
            
            .archive-item h4 {
                font-size: 1.1em;
            }
            
            .archive-item > div:first-child {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .archive-item > div:first-child > div {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ™ ê²½ê±´í•œ ìƒí™œ ì¹´ìš´í„°</h1>
            <div class="current-month" id="currentMonth"></div>
        </div>

        <div class="main-content">
            <!-- ìƒˆ í•­ëª© ì¶”ê°€ ì„¹ì…˜ -->
            <div class="add-item-section">
                <h3>ğŸ“ ìƒˆë¡œìš´ ì˜ì  í™œë™ ì¶”ê°€</h3>
                <div class="input-group">
                    <input type="text" id="newItemInput" placeholder="ì˜ˆ: ë¬µìƒ, ë´‰ì‚¬, êµ¬ì œ, ê¸°íƒ€ ì˜ì í™œë™ ë“±..." maxlength="50">
                    <button class="btn btn-primary" onclick="addItem()">ì¶”ê°€</button>
                </div>
                <small style="color: #666;">ğŸ’¡ íŒ: ë¬µìƒ, ë´‰ì‚¬, êµ¬ì œ, ì˜ˆë°°ì°¸ì„, ê¸°ë„ëª¨ì„, ì°¬ì–‘ëŒ€ ì—°ìŠµ ë“±ì˜ í™œë™ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</small>
            </div>

            <!-- ì›” ê´€ë¦¬ ì„¹ì…˜ -->
            <div class="month-controls">
                <button class="btn btn-warning" onclick="resetMonth()">ğŸ“… ìƒˆë¡œìš´ ë‹¬ ì‹œì‘í•˜ê¸°</button>
                <button class="btn btn-primary" onclick="saveCurrentMonthAsImage()" style="margin-left: 10px;">ğŸ“¸ í˜„ì¬ ë‹¬ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
                <small style="display: block; margin-top: 10px; color: #666;">
                    í˜„ì¬ ì¹´ìš´íŠ¸ë¥¼ íˆìŠ¤í† ë¦¬ë¡œ ì €ì¥í•˜ê³  ìƒˆ ë‹¬ì„ ì‹œì‘í•˜ê±°ë‚˜, í˜„ì¬ ìƒíƒœë¥¼ ì´ë¯¸ì§€ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </small>
            </div>

            <!-- í˜„ì¬ í™œë™ ëª©ë¡ -->
            <div class="items-section">
                <h3>ğŸ“Š ì´ë²ˆ ë‹¬ ì˜ì  í™œë™</h3>
                <div id="itemsList"></div>
            </div>

            <!-- íˆìŠ¤í† ë¦¬ ì„¹ì…˜ -->
            <div class="history-section">
                <h3>ğŸ“‹ ì˜¤ëŠ˜ì˜ ì˜ì  í™œë™ ê¸°ë¡</h3>
                <div class="history-list" id="historyList">
                    <div class="empty-message">ì•„ì§ ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>

            <!-- ì›”ë³„ ë³´ê´€í•¨ -->
            <div class="monthly-archive" id="monthlyArchive" style="display: none;">
                <h3>ğŸ“š ì´ì „ ë‹¬ ê¸°ë¡ ë³´ê´€í•¨</h3>
                <div id="archiveList"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK & html2canvas for image capture -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyATMvJsoUumc21yE-q8IvuEx5OSsQkKp4E",
            authDomain: "life148-count.firebaseapp.com",
            projectId: "life148-count",
            storageBucket: "life148-count.firebasestorage.app",
            messagingSenderId: "683022005130",
            appId: "1:683022005130:web:191620c21c59cfe8054e73",
            measurementId: "G-CCNLEBJLV0"
        };

        // Firebase ì´ˆê¸°í™”
        let db = null;
        let isFirebaseEnabled = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isFirebaseEnabled = true;
            console.log("Firebase ì—°ê²° ì„±ê³µ!");
        } catch (error) {
            console.log("Firebase ì—°ê²° ì‹¤íŒ¨, ë¡œì»¬ ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:", error);
            isFirebaseEnabled = false;
        }

        // ë°ì´í„° ì €ì¥ ê°ì²´
        let spiritualData = {
            items: [
                { id: 1, name: 'ê¸°ë„', count: 0 },
                { id: 2, name: 'ì„±ê²½ì½ê¸°', count: 0 },
                { id: 3, name: 'ì°¬ì–‘', count: 0 },
                { id: 4, name: 'ì‹¬ë°©', count: 0 },
                { id: 5, name: 'ìƒë‹´', count: 0 },
                { id: 6, name: 'ì„¤êµì¤€ë¹„', count: 0 },
                { id: 7, name: 'ì „ë„ì§‘íšŒ', count: 0 }
            ],
            history: [],
            monthlyArchive: [],
            currentMonth: new Date().getMonth() + 1,
            currentYear: new Date().getFullYear(),
            nextId: 8,
            userId: 'pastor_david' // ê³ ìœ  ì‚¬ìš©ì ID
        };

        // ë¡œì»¬ ì €ì¥ì†Œ í•¨ìˆ˜ë“¤
        function saveToLocalStorage() {
            if (!isFirebaseEnabled) {
                localStorage.setItem('spiritualLifeData', JSON.stringify(spiritualData));
            }
        }

        function loadFromLocalStorage() {
            if (!isFirebaseEnabled) {
                const saved = localStorage.getItem('spiritualLifeData');
                if (saved) {
                    const loadedData = JSON.parse(saved);
                    // ê¸°ì¡´ ë°ì´í„° êµ¬ì¡°ì™€ ë³‘í•©
                    Object.assign(spiritualData, loadedData);
                }
            }
        }

        // Firebase ì €ì¥ í•¨ìˆ˜
        async function saveToFirebase() {
            if (!isFirebaseEnabled) return;
            
            try {
                await db.collection('spiritualLife').doc(spiritualData.userId).set(spiritualData);
                console.log("ë°ì´í„°ê°€ í´ë¼ìš°ë“œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (error) {
                console.error("Firebase ì €ì¥ ì˜¤ë¥˜:", error);
                alert("í´ë¼ìš°ë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        }

        // Firebase ë¡œë“œ í•¨ìˆ˜
        async function loadFromFirebase() {
            if (!isFirebaseEnabled) return;
            
            try {
                const doc = await db.collection('spiritualLife').doc(spiritualData.userId).get();
                if (doc.exists) {
                    const loadedData = doc.data();
                    Object.assign(spiritualData, loadedData);
                    console.log("í´ë¼ìš°ë“œì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                } else {
                    console.log("í´ë¼ìš°ë“œì— ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    await saveToFirebase(); // ì´ˆê¸° ë°ì´í„° ì €ì¥
                }
            } catch (error) {
                console.error("Firebase ë¡œë“œ ì˜¤ë¥˜:", error);
                alert("í´ë¼ìš°ë“œ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // í†µí•© ì €ì¥ í•¨ìˆ˜
        async function saveData() {
            if (isFirebaseEnabled) {
                await saveToFirebase();
            } else {
                saveToLocalStorage();
            }
        }

        // í†µí•© ë¡œë“œ í•¨ìˆ˜
        async function loadData() {
            if (isFirebaseEnabled) {
                await loadFromFirebase();
            } else {
                loadFromLocalStorage();
            }
        }

        // ì´ë¯¸ì§€ ì €ì¥ ê´€ë ¨ í•¨ìˆ˜ë“¤
        async function saveCurrentMonthAsImage() {
            try {
                // í˜„ì¬ í™”ë©´ì„ ìº¡ì²˜í•  ì„ì‹œ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
                const reportElement = await createMonthlyReport();
                
                // html2canvasë¡œ ì´ë¯¸ì§€ ìƒì„±
                const canvas = await html2canvas(reportElement, {
                    backgroundColor: '#ffffff',
                    scale: 2, // ê³ í•´ìƒë„
                    useCORS: true,
                    logging: false
                });
                
                // ìº”ë²„ìŠ¤ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•˜ì—¬ ë‹¤ìš´ë¡œë“œ
                const link = document.createElement('a');
                link.download = `ê²½ê±´í•œìƒí™œ_${spiritualData.currentYear}ë…„${spiritualData.currentMonth}ì›”_ê¸°ë¡.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // ì„ì‹œ ì—˜ë¦¬ë¨¼íŠ¸ ì œê±°
                document.body.removeChild(reportElement);
                
                alert('ğŸ“¸ ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function createMonthlyReport() {
            // í˜„ì¬ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë³´ê³ ì„œ HTML ìƒì„±
            const reportContainer = document.createElement('div');
            reportContainer.style.cssText = `
                position: absolute;
                top: -9999px;
                left: -9999px;
                width: 800px;
                background: white;
                padding: 40px;
                font-family: Arial, sans-serif;
                box-sizing: border-box;
            `;
            
            const currentDate = new Date().toLocaleDateString('ko-KR');
            const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', 
                              '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
            
            reportContainer.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #4facfe; padding-bottom: 20px;">
                    <h1 style="color: #4facfe; margin: 0; font-size: 2.2em;">ğŸ™ ê²½ê±´í•œ ìƒí™œ ê¸°ë¡</h1>
                    <h2 style="color: #666; margin: 10px 0 0 0;">${spiritualData.currentYear}ë…„ ${monthNames[spiritualData.currentMonth - 1]}</h2>
                    <p style="color: #999; margin: 5px 0 0 0;">ìƒì„±ì¼: ${currentDate}</p>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px;">ğŸ“Š ì´ë²ˆ ë‹¬ ì˜ì  í™œë™ í†µê³„</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                        ${spiritualData.items.map(item => `
                            <div style="padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.4em; font-weight: 600; color: #333;">${item.name}</div>
                                <div style="font-size: 2em; font-weight: 700; color: #4facfe; margin-top: 5px;">${item.count}íšŒ</div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <strong style="font-size: 1.2em; color: #333;">ì´ í™œë™ íšŸìˆ˜: ${spiritualData.items.reduce((sum, item) => sum + item.count, 0)}íšŒ</strong>
                    </div>
                </div>
                
                ${await generateDetailedRecords()}
            `;
            
            document.body.appendChild(reportContainer);
            return reportContainer;
        }

        async function generateDetailedRecords() {
            let detailsHTML = '';
            
            // ì„±ê²½ì½ê¸° ê¸°ë¡
            const bibleReadings = spiritualData.history.filter(h => h.isBibleReading);
            if (bibleReadings.length > 0) {
                detailsHTML += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #4facfe; margin-bottom: 15px;">ğŸ“– ì„±ê²½ì½ê¸° ê¸°ë¡ (${bibleReadings.length}íšŒ)</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${bibleReadings.map(reading => `
                                <div style="margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #4facfe;">
                                    <strong>${reading.bibleText}</strong>
                                    <br><small style="color: #666;">${reading.timestamp}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // ì„¤êµì¤€ë¹„ ê¸°ë¡
            const sermonPreparations = spiritualData.history.filter(h => h.isSermonPreparation);
            if (sermonPreparations.length > 0) {
                detailsHTML += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #6f42c1; margin-bottom: 15px;">ğŸ“ ì„¤êµì¤€ë¹„ ê¸°ë¡ (${sermonPreparations.length}íšŒ)</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${sermonPreparations.map(sermon => `
                                <div style="margin-bottom: 12px; padding: 12px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #6f42c1;">
                                    <div style="margin-bottom: 5px;"><strong>ì£¼ì œ:</strong> ${sermon.sermonTheme}</div>
                                    <div style="margin-bottom: 5px;"><strong>ë³¸ë¬¸:</strong> ${sermon.sermonText}</div>
                                    <div style="margin-bottom: 5px;"><strong>ëŒ€ìƒ:</strong> ${sermon.sermonTarget}</div>
                                    <small style="color: #666;">${sermon.timestamp}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // ì‹¬ë°© ê¸°ë¡
            const visitations = spiritualData.history.filter(h => h.isVisitation);
            if (visitations.length > 0) {
                detailsHTML += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #28a745; margin-bottom: 15px;">ğŸ  ì‹¬ë°© ê¸°ë¡ (${visitations.length}íšŒ)</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${visitations.map(visit => `
                                <div style="margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #28a745;">
                                    <strong>${visit.targetName}</strong> - ${visit.visitPurpose}
                                    <br><small style="color: #666;">${visit.timestamp}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // ìƒë‹´ ê¸°ë¡
            const counselings = spiritualData.history.filter(h => h.isCounseling);
            if (counselings.length > 0) {
                detailsHTML += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #fd7e14; margin-bottom: 15px;">ğŸ’¬ ìƒë‹´ ê¸°ë¡ (${counselings.length}íšŒ)</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${counselings.map(counsel => `
                                <div style="margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #fd7e14;">
                                    <strong>${counsel.counseleeName}</strong> - ${counsel.counselingTopic}
                                    <br><small style="color: #666;">${counsel.timestamp}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // ì „ë„ì§‘íšŒ ê¸°ë¡
            const evangelismMeetings = spiritualData.history.filter(h => h.isEvangelismMeeting);
            if (evangelismMeetings.length > 0) {
                detailsHTML += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #dc3545; margin-bottom: 15px;">ğŸ“¢ ì „ë„ì§‘íšŒ ê¸°ë¡ (${evangelismMeetings.length}íšŒ)</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${evangelismMeetings.map(meeting => `
                                <div style="margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #dc3545;">
                                    <strong>${meeting.meetingPeriod}</strong> - ${meeting.meetingTarget}
                                    <br><small style="color: #666;">${meeting.timestamp}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            return detailsHTML || '<p style="text-align: center; color: #666; font-style: italic;">ì´ë²ˆ ë‹¬ ìƒì„¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // ì›”ë³„ ë³´ê´€í•¨ ì‚­ì œ ê¸°ëŠ¥
        async function deleteMonthlyArchive(index) {
            if (confirm('ì´ ì›”ë³„ ê¸°ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                spiritualData.monthlyArchive.splice(index, 1);
                
                // ë°ì´í„° ì €ì¥
                await saveData();
                
                renderArchive();
                alert('ì›”ë³„ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë³´ê´€ëœ ì›”ë³„ ë°ì´í„°ë¥¼ ì´ë¯¸ì§€ë¡œ ì €ì¥
        async function saveArchivedMonthAsImage(index) {
            try {
                const archiveData = spiritualData.monthlyArchive[index];
                const reportElement = await createArchivedMonthReport(archiveData);
                
                const canvas = await html2canvas(reportElement, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    logging: false
                });
                
                const link = document.createElement('a');
                link.download = `ê²½ê±´í•œìƒí™œ_${archiveData.year}ë…„${archiveData.month}ì›”_ê¸°ë¡.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                document.body.removeChild(reportElement);
                alert('ğŸ“¸ ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function createArchivedMonthReport(archiveData) {
            const reportContainer = document.createElement('div');
            reportContainer.style.cssText = `
                position: absolute;
                top: -9999px;
                left: -9999px;
                width: 800px;
                background: white;
                padding: 40px;
                font-family: Arial, sans-serif;
                box-sizing: border-box;
            `;
            
            const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', 
                              '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
            
            reportContainer.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #4facfe; padding-bottom: 20px;">
                    <h1 style="color: #4facfe; margin: 0; font-size: 2.2em;">ğŸ™ ê²½ê±´í•œ ìƒí™œ ê¸°ë¡</h1>
                    <h2 style="color: #666; margin: 10px 0 0 0;">${archiveData.year}ë…„ ${monthNames[archiveData.month - 1]}</h2>
                    <p style="color: #999; margin: 5px 0 0 0;">ë³´ê´€ì¼: ${archiveData.savedDate}</p>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px;">ğŸ“Š ì˜ì  í™œë™ í†µê³„</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                        ${archiveData.items.map(item => `
                            <div style="padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.4em; font-weight: 600; color: #333;">${item.name}</div>
                                <div style="font-size: 2em; font-weight: 700; color: #4facfe; margin-top: 5px;">${item.count}íšŒ</div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <strong style="font-size: 1.2em; color: #333;">ì´ í™œë™ íšŸìˆ˜: ${archiveData.totalActivities}íšŒ</strong>
                    </div>
                </div>
                
                ${generateArchivedDetailedRecords(archiveData)}
            `;
            
            document.body.appendChild(reportContainer);
            return reportContainer;
        }

        function generateArchivedDetailedRecords(archiveData) {
            let detailsHTML = '';
            
            // ì„±ê²½ì½ê¸° ê¸°ë¡
            if (archiveData.bibleReadings && archiveData.bibleReadings.length > 0) {
                detailsHTML += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #4facfe; margin-bottom: 15px;">ğŸ“– ì„±ê²½ì½ê¸° ê¸°ë¡ (${archiveData.bibleReadings.length}íšŒ)</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${archiveData.bibleReadings.map(reading => `
                                <div style="margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #4facfe;">
                                    <strong>${reading.bibleText}</strong>
                                    <br><small style="color: #666;">${reading.timestamp}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // ì„¤êµì¤€ë¹„ ê¸°ë¡
            if (archiveData.sermonPreparations && archiveData.sermonPreparations.length > 0) {
                detailsHTML += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #6f42c1; margin-bottom: 15px;">ğŸ“ ì„¤êµì¤€ë¹„ ê¸°ë¡ (${archiveData.sermonPreparations.length}íšŒ)</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${archiveData.sermonPreparations.map(sermon => `
                                <div style="margin-bottom: 12px; padding: 12px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #6f42c1;">
                                    <div style="margin-bottom: 5px;"><strong>ì£¼ì œ:</strong> ${sermon.sermonTheme}</div>
                                    <div style="margin-bottom: 5px;"><strong>ë³¸ë¬¸:</strong> ${sermon.sermonText}</div>
                                    <div style="margin-bottom: 5px;"><strong>ëŒ€ìƒ:</strong> ${sermon.sermonTarget}</div>
                                    <small style="color: #666;">${sermon.timestamp}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // ì‹¬ë°©, ìƒë‹´, ì „ë„ì§‘íšŒ ê¸°ë¡ë„ ë™ì¼í•˜ê²Œ ì¶”ê°€...
            if (archiveData.visitations && archiveData.visitations.length > 0) {
                detailsHTML += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #28a745; margin-bottom: 15px;">ğŸ  ì‹¬ë°© ê¸°ë¡ (${archiveData.visitations.length}íšŒ)</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${archiveData.visitations.map(visit => `
                                <div style="margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #28a745;">
                                    <strong>${visit.targetName}</strong> - ${visit.visitPurpose}
                                    <br><small style="color: #666;">${visit.timestamp}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (archiveData.counselings && archiveData.counselings.length > 0) {
                detailsHTML += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #fd7e14; margin-bottom: 15px;">ğŸ’¬ ìƒë‹´ ê¸°ë¡ (${archiveData.counselings.length}íšŒ)</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${archiveData.counselings.map(counsel => `
                                <div style="margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #fd7e14;">
                                    <strong>${counsel.counseleeName}</strong> - ${counsel.counselingTopic}
                                    <br><small style="color: #666;">${counsel.timestamp}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (archiveData.evangelismMeetings && archiveData.evangelismMeetings.length > 0) {
                detailsHTML += `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #dc3545; margin-bottom: 15px;">ğŸ“¢ ì „ë„ì§‘íšŒ ê¸°ë¡ (${archiveData.evangelismMeetings.length}íšŒ)</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${archiveData.evangelismMeetings.map(meeting => `
                                <div style="margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #dc3545;">
                                    <strong>${meeting.meetingPeriod}</strong> - ${meeting.meetingTarget}
                                    <br><small style="color: #666;">${meeting.timestamp}</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            return detailsHTML || '<p style="text-align: center; color: #666; font-style: italic;">ìƒì„¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = async function() {
            // ë¡œë”© í‘œì‹œ
            document.getElementById('currentMonth').textContent = 'ë°ì´í„° ë¡œë“œ ì¤‘...';
            
            // ë°ì´í„° ë¡œë“œ
            await loadData();
            
            // UI ì—…ë°ì´íŠ¸
            updateCurrentMonth();
            renderItems();
            renderHistory();
            renderArchive();
            
            // ì—°ê²° ìƒíƒœ í‘œì‹œ
            const statusColor = isFirebaseEnabled ? '#28a745' : '#ffc107';
            const statusText = isFirebaseEnabled ? 'í´ë¼ìš°ë“œ ë™ê¸°í™” í™œì„±í™”' : 'ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš©';
            document.getElementById('currentMonth').innerHTML += `<br><small style="color: ${statusColor};">ğŸ“¡ ${statusText}</small>`;
        };

        // í˜„ì¬ ì›” í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateCurrentMonth() {
            const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', 
                              '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
            document.getElementById('currentMonth').textContent = 
                `${spiritualData.currentYear}ë…„ ${monthNames[spiritualData.currentMonth - 1]}`;
        }

        // ìƒˆ í•­ëª© ì¶”ê°€
        async function addItem() {
            const input = document.getElementById('newItemInput');
            const itemName = input.value.trim();
            
            if (itemName === '') {
                alert('í™œë™ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì¤‘ë³µ ì²´í¬
            if (spiritualData.items.some(item => item.name.toLowerCase() === itemName.toLowerCase())) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í™œë™ì…ë‹ˆë‹¤.');
                return;
            }

            // ìƒˆ í•­ëª© ì¶”ê°€
            spiritualData.items.push({
                id: spiritualData.nextId++,
                name: itemName,
                count: 0
            });

            input.value = '';
            
            // ë°ì´í„° ì €ì¥
            await saveData();
            
            renderItems();
        }

        // í•­ëª© ëª©ë¡ ë Œë”ë§
        function renderItems() {
            const container = document.getElementById('itemsList');
            
            if (spiritualData.items.length === 0) {
                container.innerHTML = '<div class="empty-message">ì•„ì§ ë“±ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ìƒˆë¡œìš´ í™œë™ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</div>';
                return;
            }

            container.innerHTML = spiritualData.items.map(item => `
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-name">${item.name}</div>
                        <div class="item-count">${item.count}</div>
                        <div class="item-controls">
                            <button class="btn btn-success" onclick="incrementCount(${item.id})">+1</button>
                            <button class="btn btn-danger" onclick="removeItem(${item.id})" title="í•­ëª© ì‚­ì œ">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ì¹´ìš´íŠ¸ ì¦ê°€
        async function incrementCount(itemId) {
            const item = spiritualData.items.find(i => i.id === itemId);
            if (item) {
                const itemName = item.name.toLowerCase();
                
                // ì„±ê²½ì½ê¸°ì¸ ê²½ìš° ë³¸ë¬¸ ì…ë ¥ë°›ê¸°
                if (itemName === 'ì„±ê²½ì½ê¸°' || itemName.includes('ì„±ê²½')) {
                    const bibleText = prompt('ğŸ“– ì˜¤ëŠ˜ ì½ìœ¼ì‹  ì„±ê²½ ë³¸ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(ì˜ˆ: ì°½ì„¸ê¸° 1:1-10, ì‹œí¸ 23í¸, ë§ˆíƒœë³µìŒ 5ì¥ ë“±)', '');
                    
                    if (bibleText === null) return; // ì·¨ì†Œí•œ ê²½ìš°
                    
                    if (bibleText.trim() === '') {
                        alert('ì„±ê²½ ë³¸ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    item.count++;
                    
                    // ì„±ê²½ì½ê¸° íˆìŠ¤í† ë¦¬ì— ë³¸ë¬¸ í¬í•¨í•˜ì—¬ ê¸°ë¡
                    const now = new Date();
                    spiritualData.history.unshift({
                        itemName: item.name,
                        timestamp: now.toLocaleString('ko-KR'),
                        date: now.toLocaleDateString('ko-KR'),
                        bibleText: bibleText.trim(),
                        isBibleReading: true
                    });
                } 
                // ì„¤êµì¤€ë¹„ì¸ ê²½ìš° ë³¸ë¬¸, ëŒ€ìƒ, ì£¼ì œ ì…ë ¥ë°›ê¸°
                else if (itemName.includes('ì„¤êµ')) {
                    const sermonText = prompt('ğŸ“– ì„¤êµ ë³¸ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(ì˜ˆ: ìš”í•œë³µìŒ 3:16, ì‹œí¸ 23í¸, ë¡œë§ˆì„œ 8:28-30 ë“±)', '');
                    
                    if (sermonText === null) return; // ì·¨ì†Œí•œ ê²½ìš°
                    
                    if (sermonText.trim() === '') {
                        alert('ì„¤êµ ë³¸ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    const sermonTarget = prompt('ğŸ‘¥ ì„¤êµ ëŒ€ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(ì˜ˆ: ì£¼ì¼ì˜ˆë°°, ìˆ˜ìš”ì˜ˆë°°, ìƒˆë²½ê¸°ë„íšŒ, ì²­ë…„ë¶€, êµ¬ì—­ì˜ˆë°° ë“±)', '');
                    
                    if (sermonTarget === null) return; // ì·¨ì†Œí•œ ê²½ìš°
                    
                    if (sermonTarget.trim() === '') {
                        alert('ì„¤êµ ëŒ€ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    const sermonTheme = prompt('ğŸ’¡ ì„¤êµ ì£¼ì œ(ì œëª©)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(ì˜ˆ: í•˜ë‚˜ë‹˜ì˜ ì‚¬ë‘, ë¯¿ìŒì˜ ëŠ¥ë ¥, ì†Œë§ì˜ ì‚¶ ë“±)', '');
                    
                    if (sermonTheme === null) return; // ì·¨ì†Œí•œ ê²½ìš°
                    
                    if (sermonTheme.trim() === '') {
                        alert('ì„¤êµ ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    item.count++;
                    
                    // ì„¤êµì¤€ë¹„ íˆìŠ¤í† ë¦¬ì— ìƒì„¸ ì •ë³´ í¬í•¨í•˜ì—¬ ê¸°ë¡
                    const now = new Date();
                    spiritualData.history.unshift({
                        itemName: item.name,
                        timestamp: now.toLocaleString('ko-KR'),
                        date: now.toLocaleDateString('ko-KR'),
                        sermonText: sermonText.trim(),
                        sermonTarget: sermonTarget.trim(),
                        sermonTheme: sermonTheme.trim(),
                        isSermonPreparation: true
                    });
                } 
                // ì‹¬ë°©ì¸ ê²½ìš° ëŒ€ìƒì ì´ë¦„ê³¼ ëª©ì  ì…ë ¥ë°›ê¸°
                else if (itemName.includes('ì‹¬ë°©')) {
                    const targetName = prompt('ğŸ‘¥ ì‹¬ë°© ëŒ€ìƒìì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(ì˜ˆ: ê¹€ì§‘ì‚¬, ì´ê¶Œì‚¬, ë°•ì„±ë„ ë“±)', '');
                    
                    if (targetName === null) return; // ì·¨ì†Œí•œ ê²½ìš°
                    
                    if (targetName.trim() === '') {
                        alert('ëŒ€ìƒì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    const visitPurpose = prompt('ğŸ¯ ì‹¬ë°© ëª©ì ì„ ê°„ë‹¨íˆ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(ì˜ˆ: ë³‘ë¬¸ì•ˆ, ìƒì¼ì¶•í•˜, ìœ„ë¡œ, ìƒˆê°€ì¡± ì‹¬ë°©, ì •ê¸°ì‹¬ë°© ë“±)', '');
                    
                    if (visitPurpose === null) return; // ì·¨ì†Œí•œ ê²½ìš°
                    
                    if (visitPurpose.trim() === '') {
                        alert('ì‹¬ë°© ëª©ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    item.count++;
                    
                    // ì‹¬ë°© íˆìŠ¤í† ë¦¬ì— ëŒ€ìƒì ì´ë¦„ê³¼ ëª©ì  í¬í•¨í•˜ì—¬ ê¸°ë¡
                    const now = new Date();
                    spiritualData.history.unshift({
                        itemName: item.name,
                        timestamp: now.toLocaleString('ko-KR'),
                        date: now.toLocaleDateString('ko-KR'),
                        targetName: targetName.trim(),
                        visitPurpose: visitPurpose.trim(),
                        isVisitation: true
                    });
                }
                // ìƒë‹´ì¸ ê²½ìš° ëŒ€ìƒì ì´ë¦„ê³¼ ìƒë‹´ ì£¼ì œ ì…ë ¥ë°›ê¸°
                else if (itemName.includes('ìƒë‹´')) {
                    const counseleeName = prompt('ğŸ‘¥ ìƒë‹´ ëŒ€ìƒìì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(ì˜ˆ: ê¹€ì²­ë…„, ì´ì„±ë„, ë°•ì§‘ì‚¬ ë“±)', '');
                    
                    if (counseleeName === null) return; // ì·¨ì†Œí•œ ê²½ìš°
                    
                    if (counseleeName.trim() === '') {
                        alert('ìƒë‹´ ëŒ€ìƒì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    const counselingTopic = prompt('ğŸ’¬ ìƒë‹´ ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(ì˜ˆ: ì§„ë¡œê³ ë¯¼, ê°€ì •ë¬¸ì œ, ì‹ ì•™ë¬¸ì œ, ì¸ê°„ê´€ê³„, ê±´ê°•ë¬¸ì œ ë“±)', '');
                    
                    if (counselingTopic === null) return; // ì·¨ì†Œí•œ ê²½ìš°
                    
                    if (counselingTopic.trim() === '') {
                        alert('ìƒë‹´ ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    item.count++;
                    
                    // ìƒë‹´ íˆìŠ¤í† ë¦¬ì— ëŒ€ìƒì ì´ë¦„ê³¼ ì£¼ì œ í¬í•¨í•˜ì—¬ ê¸°ë¡
                    const now = new Date();
                    spiritualData.history.unshift({
                        itemName: item.name,
                        timestamp: now.toLocaleString('ko-KR'),
                        date: now.toLocaleDateString('ko-KR'),
                        counseleeName: counseleeName.trim(),
                        counselingTopic: counselingTopic.trim(),
                        isCounseling: true
                    });
                }
                // ì „ë„ì§‘íšŒì¸ ê²½ìš° ê¸°ê°„ê³¼ ëŒ€ìƒ ì…ë ¥ë°›ê¸°
                else if (itemName.includes('ì „ë„ì§‘íšŒ') || itemName.includes('ì§‘íšŒ')) {
                    const meetingPeriod = prompt('ğŸ“… ì „ë„ì§‘íšŒ ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(ì˜ˆ: 3ì¼ê°„, 1ì£¼ì¼, 5.1-5.3, 3ë°•4ì¼ ë“±)', '');
                    
                    if (meetingPeriod === null) return; // ì·¨ì†Œí•œ ê²½ìš°
                    
                    if (meetingPeriod.trim() === '') {
                        alert('ì „ë„ì§‘íšŒ ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    const meetingTarget = prompt('ğŸ‘¥ ì „ë„ì§‘íšŒ ëŒ€ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(ì˜ˆ: ì§€ì—­ì£¼ë¯¼, ì²­ë…„ë¶€, ìƒˆê°€ì¡±, ì˜¨ êµíšŒ, ì—¬ì„±ë¶€ ë“±)', '');
                    
                    if (meetingTarget === null) return; // ì·¨ì†Œí•œ ê²½ìš°
                    
                    if (meetingTarget.trim() === '') {
                        alert('ì „ë„ì§‘íšŒ ëŒ€ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    item.count++;
                    
                    // ì „ë„ì§‘íšŒ íˆìŠ¤í† ë¦¬ì— ê¸°ê°„ê³¼ ëŒ€ìƒ í¬í•¨í•˜ì—¬ ê¸°ë¡
                    const now = new Date();
                    spiritualData.history.unshift({
                        itemName: item.name,
                        timestamp: now.toLocaleString('ko-KR'),
                        date: now.toLocaleDateString('ko-KR'),
                        meetingPeriod: meetingPeriod.trim(),
                        meetingTarget: meetingTarget.trim(),
                        isEvangelismMeeting: true
                    });
                }
                else {
                    // ì¼ë°˜ í™œë™
                    item.count++;
                    
                    // íˆìŠ¤í† ë¦¬ì— ê¸°ë¡ ì¶”ê°€
                    const now = new Date();
                    spiritualData.history.unshift({
                        itemName: item.name,
                        timestamp: now.toLocaleString('ko-KR'),
                        date: now.toLocaleDateString('ko-KR'),
                        isBibleReading: false,
                        isSermonPreparation: false,
                        isVisitation: false,
                        isCounseling: false,
                        isEvangelismMeeting: false
                    });
                }

                // ë°ì´í„° ì €ì¥
                await saveData();
                
                renderItems();
                renderHistory();
            }
        }

        // í•­ëª© ì‚­ì œ
        async function removeItem(itemId) {
            if (confirm('ì´ í™œë™ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                spiritualData.items = spiritualData.items.filter(i => i.id !== itemId);
                
                // ë°ì´í„° ì €ì¥
                await saveData();
                
                renderItems();
            }
        }

        // íˆìŠ¤í† ë¦¬ ë Œë”ë§
        function renderHistory() {
            const container = document.getElementById('historyList');
            
            if (spiritualData.history.length === 0) {
                container.innerHTML = '<div class="empty-message">ì•„ì§ ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // ì˜¤ëŠ˜ ë‚ ì§œì˜ ê¸°ë¡ë§Œ í‘œì‹œ
            const today = new Date().toLocaleDateString('ko-KR');
            const todayHistory = spiritualData.history.filter(h => h.date === today);

            if (todayHistory.length === 0) {
                container.innerHTML = '<div class="empty-message">ì˜¤ëŠ˜ ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            container.innerHTML = todayHistory.map(record => {
                if (record.isBibleReading) {
                    return `
                        <div class="history-item">
                            <div>
                                <strong style="color: #4facfe;">ğŸ“– ${record.itemName}</strong>
                                <div style="margin-top: 5px; font-size: 0.9em; color: #666; font-style: italic;">
                                    ${record.bibleText}
                                </div>
                            </div>
                            <span style="color: #999; font-size: 0.9em;">${record.timestamp}</span>
                        </div>
                    `;
                } else if (record.isSermonPreparation) {
                    return `
                        <div class="history-item">
                            <div>
                                <strong style="color: #6f42c1;">ğŸ“ ${record.itemName}</strong>
                                <div style="margin-top: 5px; font-size: 0.9em; color: #666;">
                                    <div><strong>ë³¸ë¬¸:</strong> ${record.sermonText}</div>
                                    <div><strong>ëŒ€ìƒ:</strong> ${record.sermonTarget}</div>
                                    <div><strong>ì£¼ì œ:</strong> ${record.sermonTheme}</div>
                                </div>
                            </div>
                            <span style="color: #999; font-size: 0.9em;">${record.timestamp}</span>
                        </div>
                    `;
                } else if (record.isVisitation) {
                    return `
                        <div class="history-item">
                            <div>
                                <strong style="color: #28a745;">ğŸ  ${record.itemName}</strong>
                                <div style="margin-top: 5px; font-size: 0.9em; color: #666;">
                                    <div><strong>ëŒ€ìƒ:</strong> ${record.targetName}</div>
                                    <div><strong>ëª©ì :</strong> ${record.visitPurpose}</div>
                                </div>
                            </div>
                            <span style="color: #999; font-size: 0.9em;">${record.timestamp}</span>
                        </div>
                    `;
                } else if (record.isCounseling) {
                    return `
                        <div class="history-item">
                            <div>
                                <strong style="color: #fd7e14;">ğŸ’¬ ${record.itemName}</strong>
                                <div style="margin-top: 5px; font-size: 0.9em; color: #666;">
                                    <div><strong>ëŒ€ìƒ:</strong> ${record.counseleeName}</div>
                                    <div><strong>ì£¼ì œ:</strong> ${record.counselingTopic}</div>
                                </div>
                            </div>
                            <span style="color: #999; font-size: 0.9em;">${record.timestamp}</span>
                        </div>
                    `;
                } else if (record.isEvangelismMeeting) {
                    return `
                        <div class="history-item">
                            <div>
                                <strong style="color: #dc3545;">ğŸ“¢ ${record.itemName}</strong>
                                <div style="margin-top: 5px; font-size: 0.9em; color: #666;">
                                    <div><strong>ê¸°ê°„:</strong> ${record.meetingPeriod}</div>
                                    <div><strong>ëŒ€ìƒ:</strong> ${record.meetingTarget}</div>
                                </div>
                            </div>
                            <span style="color: #999; font-size: 0.9em;">${record.timestamp}</span>
                        </div>
                    `;
                } else {
                    return `
                        <div class="history-item">
                            <span><strong>${record.itemName}</strong></span>
                            <span>${record.timestamp}</span>
                        </div>
                    `;
                }
            }).join('');
        }

        // ìƒˆë¡œìš´ ë‹¬ ì‹œì‘
        async function resetMonth() {
            if (spiritualData.items.some(item => item.count > 0)) {
                if (!confirm('í˜„ì¬ ë‹¬ì˜ ê¸°ë¡ì„ ë³´ê´€í•˜ê³  ìƒˆë¡œìš´ ë‹¬ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }

                // ì´ë¯¸ì§€ ì €ì¥ ì˜µì…˜ ì œê³µ
                const saveAsImage = confirm('ìƒˆë¡œìš´ ë‹¬ì„ ì‹œì‘í•˜ê¸° ì „ì— í˜„ì¬ ë‹¬ì˜ ê¸°ë¡ì„ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë‚˜ì¤‘ì— ì´ì „ ë‹¬ ê¸°ë¡ ë³´ê´€í•¨ì—ì„œë„ ì´ë¯¸ì§€ ì €ì¥ ê°€ëŠ¥)');
                
                if (saveAsImage) {
                    try {
                        await saveCurrentMonthAsImage();
                    } catch (error) {
                        console.error('ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜:', error);
                        alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                    }
                }

                // í˜„ì¬ ë‹¬ì˜ ê° í™œë™ë³„ ê¸°ë¡ ìˆ˜ì§‘
                const currentMonthBibleReadings = spiritualData.history.filter(h => h.isBibleReading);
                const currentMonthSermonPreparations = spiritualData.history.filter(h => h.isSermonPreparation);
                const currentMonthVisitations = spiritualData.history.filter(h => h.isVisitation);
                const currentMonthCounselings = spiritualData.history.filter(h => h.isCounseling);
                const currentMonthEvangelismMeetings = spiritualData.history.filter(h => h.isEvangelismMeeting);

                // í˜„ì¬ ë‹¬ ë°ì´í„°ë¥¼ ë³´ê´€í•¨ì— ì €ì¥
                const monthData = {
                    year: spiritualData.currentYear,
                    month: spiritualData.currentMonth,
                    items: spiritualData.items.map(item => ({
                        name: item.name,
                        count: item.count
                    })),
                    bibleReadings: currentMonthBibleReadings.map(reading => ({
                        bibleText: reading.bibleText,
                        timestamp: reading.timestamp,
                        date: reading.date
                    })),
                    sermonPreparations: currentMonthSermonPreparations.map(sermon => ({
                        sermonText: sermon.sermonText,
                        sermonTarget: sermon.sermonTarget,
                        sermonTheme: sermon.sermonTheme,
                        timestamp: sermon.timestamp,
                        date: sermon.date
                    })),
                    visitations: currentMonthVisitations.map(visit => ({
                        targetName: visit.targetName,
                        visitPurpose: visit.visitPurpose,
                        timestamp: visit.timestamp,
                        date: visit.date
                    })),
                    counselings: currentMonthCounselings.map(counsel => ({
                        counseleeName: counsel.counseleeName,
                        counselingTopic: counsel.counselingTopic,
                        timestamp: counsel.timestamp,
                        date: counsel.date
                    })),
                    evangelismMeetings: currentMonthEvangelismMeetings.map(meeting => ({
                        meetingPeriod: meeting.meetingPeriod,
                        meetingTarget: meeting.meetingTarget,
                        timestamp: meeting.timestamp,
                        date: meeting.date
                    })),
                    totalActivities: spiritualData.items.reduce((sum, item) => sum + item.count, 0),
                    savedDate: new Date().toLocaleString('ko-KR')
                };

                spiritualData.monthlyArchive.unshift(monthData);
            }

            // ìƒˆ ë‹¬ ì„¤ì •
            const now = new Date();
            spiritualData.currentMonth = now.getMonth() + 1;
            spiritualData.currentYear = now.getFullYear();

            // ëª¨ë“  ì¹´ìš´íŠ¸ ë¦¬ì…‹
            spiritualData.items.forEach(item => item.count = 0);
            
            // íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
            spiritualData.history = [];

            // ë°ì´í„° ì €ì¥
            await saveData();

            updateCurrentMonth();
            renderItems();
            renderHistory();
            renderArchive();

            alert('ìƒˆë¡œìš´ ë‹¬ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ì˜ì  ìƒí™œì„ ë”ìš± í’ì„±í•˜ê²Œ ì±„ì›Œê°€ì„¸ìš”. ğŸ™');
        }

        // ì›”ë³„ ë³´ê´€í•¨ ë Œë”ë§
        function renderArchive() {
            const container = document.getElementById('monthlyArchive');
            const listContainer = document.getElementById('archiveList');
            
            if (spiritualData.monthlyArchive.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            
            listContainer.innerHTML = spiritualData.monthlyArchive.map((archive, index) => {
                let bibleReadingSection = '';
                if (archive.bibleReadings && archive.bibleReadings.length > 0) {
                    bibleReadingSection = `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <h5 style="color: #4facfe; margin-bottom: 10px;">ğŸ“– ì„±ê²½ì½ê¸° ê¸°ë¡ (${archive.bibleReadings.length}íšŒ)</h5>
                            <div style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                                ${archive.bibleReadings.map(reading => `
                                    <div style="margin-bottom: 8px; padding: 5px; background: white; border-radius: 3px; font-size: 0.9em;">
                                        <strong>${reading.bibleText}</strong>
                                        <br><small style="color: #666;">${reading.timestamp}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                let sermonPreparationSection = '';
                if (archive.sermonPreparations && archive.sermonPreparations.length > 0) {
                    sermonPreparationSection = `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <h5 style="color: #6f42c1; margin-bottom: 10px;">ğŸ“ ì„¤êµì¤€ë¹„ ê¸°ë¡ (${archive.sermonPreparations.length}íšŒ)</h5>
                            <div style="max-height: 250px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                                ${archive.sermonPreparations.map(sermon => `
                                    <div style="margin-bottom: 12px; padding: 8px; background: white; border-radius: 3px; font-size: 0.9em; border-left: 3px solid #6f42c1;">
                                        <div style="margin-bottom: 5px;"><strong>ì£¼ì œ:</strong> ${sermon.sermonTheme}</div>
                                        <div style="margin-bottom: 5px;"><strong>ë³¸ë¬¸:</strong> ${sermon.sermonText}</div>
                                        <div style="margin-bottom: 5px;"><strong>ëŒ€ìƒ:</strong> ${sermon.sermonTarget}</div>
                                        <small style="color: #666;">${sermon.timestamp}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                let visitationSection = '';
                if (archive.visitations && archive.visitations.length > 0) {
                    visitationSection = `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <h5 style="color: #28a745; margin-bottom: 10px;">ğŸ  ì‹¬ë°© ê¸°ë¡ (${archive.visitations.length}íšŒ)</h5>
                            <div style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                                ${archive.visitations.map(visit => `
                                    <div style="margin-bottom: 8px; padding: 5px; background: white; border-radius: 3px; font-size: 0.9em;">
                                        <strong>${visit.targetName}</strong> - ${visit.visitPurpose}
                                        <br><small style="color: #666;">${visit.timestamp}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                let counselingSection = '';
                if (archive.counselings && archive.counselings.length > 0) {
                    counselingSection = `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <h5 style="color: #fd7e14; margin-bottom: 10px;">ğŸ’¬ ìƒë‹´ ê¸°ë¡ (${archive.counselings.length}íšŒ)</h5>
                            <div style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                                ${archive.counselings.map(counsel => `
                                    <div style="margin-bottom: 8px; padding: 5px; background: white; border-radius: 3px; font-size: 0.9em;">
                                        <strong>${counsel.counseleeName}</strong> - ${counsel.counselingTopic}
                                        <br><small style="color: #666;">${counsel.timestamp}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                let evangelismMeetingSection = '';
                if (archive.evangelismMeetings && archive.evangelismMeetings.length > 0) {
                    evangelismMeetingSection = `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <h5 style="color: #dc3545; margin-bottom: 10px;">ğŸ“¢ ì „ë„ì§‘íšŒ ê¸°ë¡ (${archive.evangelismMeetings.length}íšŒ)</h5>
                            <div style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                                ${archive.evangelismMeetings.map(meeting => `
                                    <div style="margin-bottom: 8px; padding: 5px; background: white; border-radius: 3px; font-size: 0.9em;">
                                        <strong>${meeting.meetingPeriod}</strong> - ${meeting.meetingTarget}
                                        <br><small style="color: #666;">${meeting.timestamp}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="archive-item">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0;">${archive.year}ë…„ ${archive.month}ì›” ê¸°ë¡</h4>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="saveArchivedMonthAsImage(${index})" style="font-size: 0.9em; padding: 8px 12px;">ğŸ“¸ ì´ë¯¸ì§€ ì €ì¥</button>
                                <button class="btn btn-danger" onclick="deleteMonthlyArchive(${index})" style="font-size: 0.9em; padding: 8px 12px;">ğŸ—‘ï¸ ì‚­ì œ</button>
                            </div>
                        </div>
                        <p><strong>ì´ í™œë™ íšŸìˆ˜:</strong> ${archive.totalActivities}íšŒ</p>
                        <div style="margin-top: 10px;">
                            ${archive.items.map(item => `
                                <span style="display: inline-block; margin-right: 15px; margin-bottom: 5px;">
                                    <strong>${item.name}:</strong> ${item.count}íšŒ
                                </span>
                            `).join('')}
                        </div>
                        ${bibleReadingSection}
                        ${sermonPreparationSection}
                        ${visitationSection}
                        ${counselingSection}
                        ${evangelismMeetingSection}
                        <small style="color: #666;">ë³´ê´€ì¼: ${archive.savedDate}</small>
                    </div>
                `;
            }).join('');
        }

        // Enter í‚¤ë¡œ í•­ëª© ì¶”ê°€
        document.getElementById('newItemInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addItem();
            }
        });
    </script>
</body>
</html>